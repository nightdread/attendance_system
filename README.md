# Система учета прихода/ухода сотрудников

Система учета рабочего времени на базе Telegram-бота и QR-кодов.

## Возможности

- ✅ **JWT Аутентификация** - безопасная аутентификация пользователей
- ✅ **Redis Кэширование** - высокая производительность (опционально)
- ✅ **Унифицированная система** - общий учет для всех сотрудников
- ✅ **Одноразовые QR-коды** - каждый код используется только один раз
- ✅ **Автоматическая генерация** новых токенов после использования
- ✅ **Регистрация пользователей** через Telegram-бот
- ✅ **Отметка прихода/ухода** для всех сотрудников
- ✅ **Веб-терминал** для отображения QR-кодов
- ✅ **Интерактивная аналитика** - графики и отчеты в реальном времени
- ✅ **Структурированное логирование** с ротацией
- ✅ **API Документация** - Swagger/OpenAPI
- ✅ **Docker поддержка** - легкое развертывание

## Архитектура

- **Backend**: FastAPI + SQLite + Redis (опционально)
- **Bot**: Python Telegram Bot
- **Web Interface**: HTML/JS с Chart.js для графиков
- **Cache**: Redis или in-memory fallback
- **Database**: SQLite (файл `attendance.db`)
- **Authentication**: JWT tokens

## Установка

1. **Клонируйте репозиторий**
   ```bash
   git clone <repository-url>
   cd attendance-system
   ```

2. **Установите зависимости**
   ```bash
   pip install -r requirements.txt
   ```

3. **Настройте конфигурацию**

   Отредактируйте `config/config.py`:
   ```python
   BOT_TOKEN = "ВАШ_ТОКЕН_БОТА_ТЕЛЕГРАМ"
   BOT_USERNAME = "username_вашего_бота"
   WEB_USERNAME = "admin"  # логин для веб-терминала
   WEB_PASSWORD = "ваш_пароль"
   ```

## Запуск

### Вариант 1: Docker (рекомендуется)

#### Запуск с Redis кэшированием:
```bash
# Установите BOT_TOKEN в переменные окружения
export BOT_TOKEN="your_telegram_bot_token"

# Запустите систему
docker-compose up -d
```

#### Или запустите только приложение:
```bash
docker build -t attendance-system .
docker run -p 8000:8000 -v $(pwd)/attendance.db:/app/attendance.db attendance-system
```

### Вариант 2: Локальный запуск

#### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

#### 2. Конфигурация Redis (опционально)
```bash
export REDIS_ENABLED=true
export REDIS_HOST=localhost
export REDIS_PORT=6379
```

#### 3. Запуск системы
```bash
python run.py
```

Приложение будет доступно на `http://localhost:8000`

## Использование

### 1. Настройка бота
- Создайте бота через [@BotFather](https://t.me/botfather)
- Получите токен и username бота
- Установите их в `config/config.py`

### 2. Доступ к веб-терминалу
- Откройте браузер: `http://localhost:8000/login`
- Введите логин/пароль из конфига
- Выберите локацию и сканируйте QR-код

### 3. Работа с ботом
- Пользователи сканируют QR-код на терминале
- При первом использовании вводят ФИО
- Выбирают "Пришёл" или "Ушёл"

### 4. Команды бота
- `/start` - начало работы
- `/my_last` - последние события пользователя
- `/who_here` - кто сейчас в офисе

### 5. Админ-панель
- `http://localhost:8000/admin` - просмотр присутствующих
- `http://localhost:8000/admin/user/{id}` - история пользователя

## API Endpoints

### Получение токена
```
GET /api/active_token/{location_id}
```
Возвращает активный токен для локации или создает новый.

### Веб-интерфейсы
- `/login` - вход в систему
- `/terminal` - терминал с QR-кодом
- `/admin` - админ-панель
- `/logout` - выход

## Структура базы данных

### Таблицы:
- `people` - пользователи (tg_user_id, fio, username)
- `events` - события (user_id, location, action, timestamp)
- `tokens` - токены (token, location, used, timestamps)

## Разработка

### Добавление новой локации
Добавьте локацию в `config/config.py` в список `LOCATIONS`.

### Кастомизация
- Шаблоны: `templates/`
- Стили: редактируйте HTML в шаблонах
- Логика: `backend/database.py`, `bot/bot.py`

## Безопасность

- QR-коды одноразовые
- Токены истекают через 24 часа
- Веб-интерфейс защищен логином/паролем
- Данные хранятся локально в SQLite

## TODO (будущие улучшения)

- [ ] ESP32 интеграция
- [ ] PostgreSQL поддержка
- [ ] Более детальная отчетность
- [ ] Экспорт данных в Excel
- [ ] Мобильное приложение
- [ ] Push-уведомления

## Лицензия

MIT License
