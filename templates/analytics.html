<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –°–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --border: #1f2937;
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
            --success: #22c55e;
            --warn: #f59e0b;
            --danger: #ef4444;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .nav {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav a {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(14,165,233,0.25);
            transition: background 0.15s ease, transform 0.1s ease;
        }
        .nav a:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        .section {
            background: var(--card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }
        .section h2 {
            margin-top: 0;
            color: var(--text);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .collapse-btn {
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .collapse-btn:hover {
            background: rgba(14,165,233,0.1);
            transform: scale(1.1);
        }
        .section-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        .section-content.expanded {
            max-height: 5000px;
            opacity: 1;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 6px 16px rgba(14,165,233,0.3);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 1rem 0;
        }
        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }
        th {
            background-color: #0b1220;
            font-weight: 600;
        }
        .top-worker {
            background: rgba(14,165,233,0.08);
        }
        .department-card {
            background: #0b1220;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }
        .progress-bar {
            background: #1f2937;
            border-radius: 4px;
            height: 8px;
            margin-top: 0.5rem;
        }
        .progress-fill {
            background: var(--accent);
            height: 100%;
            border-radius: 4px;
        }
        .no-data {
            text-align: center;
            color: var(--muted);
            padding: 3rem;
            font-style: italic;
        }
        .metric-positive {
            color: var(--success);
        }
        .metric-neutral {
            color: var(--muted);
        }
        .metric-highlight {
            background: rgba(14,165,233,0.08);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .legend-box {
            margin-top: 2rem;
            padding: 1rem;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--accent);
            color: var(--text);
        }
        .legend-box h4 {
            margin: 0 0 0.75rem 0;
            color: var(--accent);
        }
        .legend-items {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .legend-pill {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }
        .legend-admin {
            background: #0ea5e9;
        }
        .legend-employee {
            background: #22c55e;
        }
        .calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .calendar-wrapper {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .calendar-nav-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.15s ease;
        }
        .calendar-nav-btn:hover {
            background: var(--accent-hover);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--muted);
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #0b1220;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        .calendar-day:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }
        .calendar-day.other-month {
            opacity: 0.3;
        }
        .calendar-day.today {
            border-color: var(--accent);
            background: rgba(14,165,233,0.1);
        }
        .calendar-day.holiday {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.5);
        }
        .calendar-day.holiday:hover {
            background: rgba(220, 53, 69, 0.3);
            border-color: rgba(220, 53, 69, 0.7);
        }
        .calendar-day.holiday .calendar-day-number {
            color: #ff6b6b;
        }
        .calendar-day.today.holiday {
            border-color: #ff6b6b;
            background: rgba(220, 53, 69, 0.15);
        }
        .calendar-day.has-visits {
            background: rgba(34,197,94,0.2);
            border-color: var(--success);
        }
        .calendar-day.has-visits.many-visits {
            background: rgba(34,197,94,0.4);
        }
        .calendar-day.holiday.has-visits {
            background: rgba(220, 53, 69, 0.3);
        }
        .calendar-day-number {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .calendar-day-visits {
            font-size: 0.7rem;
            color: var(--success);
            margin-top: 0.2rem;
        }
        .date-filter {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .date-filter input[type="date"] {
            padding: 0.5rem;
            background: #0b1220;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 1rem;
        }
        .date-filter button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.15s ease;
        }
        .date-filter button:hover {
            background: var(--accent-hover);
        }
        .day-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow: auto;
        }
        .day-modal-content {
            background-color: var(--card);
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: var(--shadow);
            max-height: 80vh;
            overflow-y: auto;
        }
        .day-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 1rem;
        }
        .day-modal-close {
            color: var(--muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        .day-modal-close:hover {
            color: var(--text);
        }
        .employees-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .employee-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #0b1220;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .employee-info {
            flex: 1;
        }
        .employee-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        .employee-meta {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .employee-times {
            text-align: right;
            font-size: 0.9rem;
        }
        .time-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            font-size: 0.85rem;
        }
        .time-checkin {
            background: rgba(34,197,94,0.2);
            color: var(--success);
        }
        .time-checkout {
            background: rgba(239,68,68,0.2);
            color: var(--danger);
        }
        .no-employees {
            text-align: center;
            color: var(--muted);
            padding: 2rem;
        }
        /* Responsive table styles */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .calendar-container {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
            table {
                font-size: 0.85rem;
            }
            table th, table td {
                padding: 0.5rem 0.25rem;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .stat-value {
                font-size: 2rem;
            }
            table {
                font-size: 0.75rem;
            }
        }
        /* Mobile styles */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .container {
                max-width: 100%;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .nav {
                flex-direction: column;
                gap: 0.5rem;
            }
            .nav a {
                width: 100%;
                text-align: center;
                padding: 0.75rem;
                min-height: 44px;
            }
            .section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .section h2 {
                font-size: 1.1rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            .stat-card {
                padding: 1rem;
            }
            .stat-value {
                font-size: 2rem;
            }
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .chart-container {
                height: 300px;
            }
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            th, td {
                padding: 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
            }
            .department-card {
                padding: 0.75rem;
            }
            .employee-card {
                flex-direction: column;
                align-items: flex-start;
            }
            .employee-times {
                text-align: left;
                margin-top: 0.5rem;
                width: 100%;
            }
            .time-badge {
                display: block;
                margin: 0.25rem 0;
                margin-left: 0;
            }
            .date-picker {
                flex-direction: column;
                gap: 0.5rem;
            }
            .date-picker input {
                width: 100%;
                padding: 0.75rem;
                min-height: 44px;
            }
            .date-picker button {
                width: 100%;
                padding: 0.75rem;
                min-height: 44px;
            }
            .day-modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 1rem;
                max-height: 85vh;
            }
            .day-modal-header {
                font-size: 1rem;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
            }
            .day-modal-close {
                font-size: 24px;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }
            .section {
                padding: 0.75rem;
            }
            .header h1 {
                font-size: 1.25rem;
            }
            .stat-value {
                font-size: 1.75rem;
            }
            .chart-container {
                height: 250px;
            }
            .export-btn:hover {
                opacity: 0.9;
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .export-btn:active {
                transform: translateY(0);
            }
            th, td {
                padding: 0.4rem;
                font-size: 0.8rem;
            }
            .day-modal-content {
                width: 98%;
                margin: 5% auto;
                padding: 0.75rem;
            }
            .day-modal-header {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏</h1>
            <p>–û—Ç—á–µ—Ç –∑–∞ {{ analytics_summary.today_visits or 0 }} –ø–æ—Å–µ—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</p>
        </div>

        <div class="nav">
            <a href="/">üè† –¢–µ—Ä–º–∏–Ω–∞–ª</a>
            <a href="/admin">üë• –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</a>
            <a href="/users">‚öôÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            <a href="/logout">üö™ –í—ã—Ö–æ–¥</a>
        </div>

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="section">
            <h2 onclick="toggleSection('stats-section')">
                <span>üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('stats-section')">‚ñ∂</button>
            </h2>
            <div id="stats-section" class="section-content collapsed">
                <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value">{{ analytics_summary.total_users }}</span>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ analytics_summary.currently_present }}</span>
                    <div class="stat-label">–°–µ–π—á–∞—Å –≤ –æ—Ñ–∏—Å–µ</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ analytics_summary.today_visits }}</span>
                    <div class="stat-label">–ü–æ—Å–µ—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">{{ analytics_summary.avg_work_time|format_hours if analytics_summary.avg_work_time else "-" }}</span>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (30 –¥–Ω–µ–π)</div>
                </div>
                </div>
            </div>
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
        <div class="section">
            <h2 onclick="toggleSection('calendar-section')">
                <span>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('calendar-section')">‚ñ∂</button>
            </h2>
            <div id="calendar-section" class="section-content collapsed">
            <div class="calendar-container">
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
                        <h3 id="calendar-month-year"></h3>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>
            </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="section">
            <h2 onclick="toggleSection('charts-section')">
                <span>üìä –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('charts-section')">‚ñ∂</button>
            </h2>
            <div id="charts-section" class="section-content collapsed">
            <div class="charts-grid">
                <div>
                    <h3>–ü–æ—Å–µ—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º (7 –¥–Ω–µ–π)</h3>
                    <div class="chart-container">
                        <canvas id="dailyVisitsChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —á–∞—Å–∞–º</h3>
                    <div class="chart-container">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- –¢–æ–ø —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ -->
        <div class="section">
            <h2 onclick="toggleSection('top-workers-section')">
                <span>üèÜ –¢–æ–ø —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ (–∑–∞ 30 –¥–Ω–µ–π)</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('top-workers-section')">‚ñ∂</button>
            </h2>
            <div id="top-workers-section" class="section-content collapsed">
            {% if top_workers %}
            <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                        <th>–†–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</th>
                        <th>–û–±—â–µ–µ –≤—Ä–µ–º—è (—á–∞—Å—ã)</th>
                        <th>–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for worker in top_workers %}
                    <tr class="{% if loop.index <= 3 %}top-worker{% endif %}">
                        <td>
                            {% if loop.index == 1 %}ü•á
                            {% elif loop.index == 2 %}ü•à
                            {% elif loop.index == 3 %}ü•â
                            {% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td>{{ worker.name }}</td>
                        <td>{{ worker.work_days }}</td>
                        <td class="metric-highlight">{{ worker.total_hours|format_hours }}</td>
                        <td>{{ ((worker.total_hours / worker.work_days) if worker.work_days > 0 else 0)|format_hours }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
            {% else %}
            <div class="no-data">
                <p>üìù –î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –µ—â–µ –Ω–µ —Å–æ–±—Ä–∞–Ω—ã.</p>
                <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–∞—á–Ω—É—Ç –æ—Ç–º–µ—á–∞—Ç—å –ø—Ä–∏—Ö–æ–¥ –∏ —É—Ö–æ–¥.</p>
            </div>
            {% endif %}
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
        <div class="section">
            <h2 onclick="toggleSection('departments-section')">
                <span>üè¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('departments-section')">‚ñ∂</button>
            </h2>
            <div id="departments-section" class="section-content collapsed">
            {% if department_stats %}
                {% for dept in department_stats %}
                <div class="department-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ dept.department }}</strong>
                            {% if dept.user_type == 'web' %}
                                <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">–ê–î–ú–ò–ù</span>
                            {% elif dept.user_type == 'regular' %}
                                <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">–°–û–¢–†–£–î–ù–ò–ö–ò</span>
                            {% endif %}
                            <div style="color: #666; font-size: 0.9rem;">
                                {{ dept.user_count }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Ä¢ {{ dept.active_users }} –∞–∫—Ç–∏–≤–Ω—ã—Ö
                                {% if dept.user_type == 'regular' %}
                                    <em>(–æ—Ç–º–µ—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ QR)</em>
                                {% endif %}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; {% if dept.active_users == 0 %}color: #dc3545;{% endif %}">
                                {{ "%.0f"|format(dept.active_users / dept.user_count * 100 if dept.user_count > 0 else 0) }}%
                            </div>
                            <div style="color: #666; font-size: 0.8rem;">–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ "%.0f"|format(dept.active_users / dept.user_count * 100 if dept.user_count > 0 else 0) }}%;
                            {% if dept.active_users == 0 %}background: #dc3545;{% endif %}"></div>
                    </div>
                </div>
                {% endfor %}

                <div class="legend-box">
                    <h4>üìä –õ–µ–≥–µ–Ω–¥–∞:</h4>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-pill legend-admin">–ê–î–ú–ò–ù</span>
                            <span>–í–µ–±-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (admin, hr, manager)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-pill legend-employee">–°–û–¢–†–£–î–ù–ò–ö–ò</span>
                            <span>–û–±—ã—á–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ (—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞)</span>
                        </div>
                    </div>
                </div>
            {% else %}
            <div class="no-data">
                <p>üè¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</p>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
            </div>
            {% endif %}
            </div>
        </div>

        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
        <div class="section">
            <h2 onclick="toggleSection('employee-section')">
                <span>üë§ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('employee-section')">‚ñ∂</button>
            </h2>
            <div id="employee-section" class="section-content collapsed">
            <div style="margin-bottom: 1rem;">
                <label for="employee-select" style="font-weight: bold; margin-right: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:</label>
                <select id="employee-select" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
                    {% for employee in employee_list %}
                    <option value="{{ employee.id }}">{{ employee.fio }} (@{{ employee.username or '–Ω–µ—Ç' }})</option>
                    {% endfor %}
                </select>
                <button onclick="loadEmployeeStats()" style="margin-left: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            </div>

            <div id="employee-stats" style="display: none;">
                <div id="employee-info" class="stats-grid" style="margin-bottom: 2rem;"></div>
                <div id="employee-details"></div>
            </div>
            </div>
        </div>

        <!-- –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ -->
        <div class="section">
            <h2 onclick="toggleSection('export-section')">
                <span>üì• –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ –≤ Excel</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('export-section')">‚ñ∂</button>
            </h2>
            <div id="export-section" class="section-content collapsed">
                <div style="padding: 1rem;">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
                        <button onclick="exportReport('last_week')" class="export-btn" style="padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                            üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è
                        </button>
                        <button onclick="exportReport('last_month')" class="export-btn" style="padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                            üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü
                        </button>
                        <button onclick="exportReport('current_month')" class="export-btn" style="padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                            üìÖ –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
                        </button>
                    </div>
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
                        <h3>–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç:</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-top: 1rem;">
                            <div>
                                <label for="export-start-date" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">–°:</label>
                                <input type="date" id="export-start-date" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; font-size: 1rem;">
                            </div>
                            <div>
                                <label for="export-end-date" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">–ü–æ:</label>
                                <input type="date" id="export-end-date" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; font-size: 1rem;">
                            </div>
                            <div style="align-self: flex-end;">
                                <button onclick="exportReportByDate()" class="export-btn" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                                    üìä –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="export-status" style="margin-top: 1rem; padding: 0.75rem; border-radius: 4px; display: none;"></div>
                </div>
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="section">
            <h2 onclick="toggleSection('info-section')">
                <span>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                <button class="collapse-btn" onclick="event.stopPropagation(); toggleSection('info-section')">‚ñ∂</button>
            </h2>
            <div id="info-section" class="section-content collapsed">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div>
                    <h4>üìÖ –ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞</h4>
                    <p>–ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.</p>
                    <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º - –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.</p>
                </div>
                <div>
                    <h4>‚è∞ –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏</h4>
                    <p>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∞ –¥–æ –º–æ–º–µ–Ω—Ç–∞ —É—Ö–æ–¥–∞.</p>
                    <p>–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (–ø—Ä–∏—Ö–æ–¥ + —É—Ö–æ–¥).</p>
                </div>
                <div>
                    <h4>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</p>
                    <p>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–Ω—è -->
    <div id="dayModal" class="day-modal">
        <div class="day-modal-content">
            <div class="day-modal-header">
                <h2 id="dayModalTitle">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                <button class="day-modal-close" onclick="closeDayModal()">&times;</button>
            </div>
            <div id="dayModalBody">
                <div class="no-employees">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const btn = section.previousElementSibling.querySelector('.collapse-btn');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                section.classList.add('expanded');
                btn.textContent = '‚ñº';
            } else {
                section.classList.remove('expanded');
                section.classList.add('collapsed');
                btn.textContent = '‚ñ∂';
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
            localStorage.setItem(`section_${sectionId}`, section.classList.contains('collapsed') ? 'collapsed' : 'expanded');
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            const sections = ['stats-section', 'calendar-section', 'charts-section', 'top-workers-section', 
                             'departments-section', 'employee-section', 'info-section'];
            
            sections.forEach(sectionId => {
                const savedState = localStorage.getItem(`section_${sectionId}`);
                const section = document.getElementById(sectionId);
                const btn = section.previousElementSibling.querySelector('.collapse-btn');
                
                if (section && btn) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –æ–Ω–æ expanded, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                    if (savedState === 'expanded') {
                        section.classList.remove('collapsed');
                        section.classList.add('expanded');
                        btn.textContent = '‚ñº';
                    } else {
                        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Å–≤–µ—Ä–Ω—É—Ç—ã
                        section.classList.remove('expanded');
                        section.classList.add('collapsed');
                        btn.textContent = '‚ñ∂';
                    }
                }
            });
        });

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const dailyVisitsData = {{ daily_visits|tojson }};
        const hourlyData = {{ hourly_distribution|tojson }};

        // –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ –¥–Ω—è–º
        const dailyCtx = document.getElementById('dailyVisitsChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: dailyVisitsData.map(d => new Date(d.date).toLocaleDateString('ru-RU')),
                datasets: [{
                    label: '–ü–æ—Å–µ—â–µ–Ω–∏–π',
                    data: dailyVisitsData.map(d => d.visits),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —á–∞—Å–∞–º
        const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
        new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: hourlyData.map(d => `${d.hour}:00`),
                datasets: [{
                    label: '–ü–æ—Å–µ—â–µ–Ω–∏–π',
                    data: hourlyData.map(d => d.count),
                    backgroundColor: 'rgba(0, 123, 255, 0.6)',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å–æ–≤ –≤ –ß–ß:–ú–ú
        function formatHoursToHHMM(hours) {
            if (!hours || hours <= 0) return "-";
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            return `${wholeHours}:${minutes.toString().padStart(2, '0')}`;
        }

        // Employee statistics functionality
        async function loadEmployeeStats() {
            const employeeId = document.getElementById('employee-select').value;
            if (!employeeId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
                return;
            }

            try {
                const response = await fetch(`/api/employee/${employeeId}`);
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É');
                }

                const data = await response.json();
                displayEmployeeStats(data);
            } catch (error) {
                console.error('Error loading employee stats:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            }
        }

        function displayEmployeeStats(data) {
            const statsDiv = document.getElementById('employee-stats');
            const infoDiv = document.getElementById('employee-info');
            const detailsDiv = document.getElementById('employee-details');

            // Basic info cards
            infoDiv.innerHTML = `
                <div class="stat-card">
                    <span class="stat-value">${data.fio}</span>
                    <div class="stat-label">–§–ò–û</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">@${data.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                    <div class="stat-label">Username</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" style="color: ${data.is_present ? '#28a745' : '#dc3545'}">${data.is_present ? '–í –æ—Ñ–∏—Å–µ' : '–ù–µ –≤ –æ—Ñ–∏—Å–µ'}</span>
                    <div class="stat-label">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${data.total_work_days}</span>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π</div>
                </div>
            `;

            // Detailed statistics
            let detailsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 2rem;">
                    <div>
                        <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <table style="width: 100%; margin-top: 1rem;">
                            <tr><td>–í—Å–µ–≥–æ –ø—Ä–∏—Ö–æ–¥–æ–≤:</td><td style="text-align: right; font-weight: bold;">${data.total_checkins}</td></tr>
                            <tr><td>–í—Å–µ–≥–æ —É—Ö–æ–¥–æ–≤:</td><td style="text-align: right; font-weight: bold;">${data.total_checkouts}</td></tr>
                            <tr><td>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</td><td style="text-align: right; font-weight: bold;">${formatHoursToHHMM(data.avg_work_time)}</td></tr>
                            <tr><td>–ü–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ:</td><td style="text-align: right;">${data.first_visit || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td></tr>
                            <tr><td>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ:</td><td style="text-align: right;">${data.last_visit || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</td></tr>
                        </table>
                        </div>
                    </div>

                    <div>
                        <h3>üìÖ –ú–µ—Å—è—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; margin-top: 1rem;">
                                <thead>
                                    <tr><th>–ú–µ—Å—è—Ü</th><th>–î–Ω–∏</th><th>–ü–æ—Å–µ—â–µ–Ω–∏–π</th></tr>
                                </thead>
                                <tbody>
            `;

            if (data.monthly_stats && data.monthly_stats.length > 0) {
                data.monthly_stats.forEach(month => {
                    detailsHtml += `<tr><td>${month.month}</td><td>${month.work_days}</td><td>${month.checkins}</td></tr>`;
                });
            } else {
                detailsHtml += `<tr><td colspan="3" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –º–µ—Å—è—Ü—ã</td></tr>`;
            }

            detailsHtml += `
                                </tbody>
                            </table>
                        </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Ä–∞–±–æ—Ç—ã</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; margin-top: 1rem;">
                            <thead>
                                <tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–∏—Ö–æ–¥</th><th>–£—Ö–æ–¥</th><th>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</th></tr>
                            </thead>
                            <tbody>
            `;

            if (data.recent_sessions && data.recent_sessions.length > 0) {
                data.recent_sessions.forEach(session => {
                    detailsHtml += `<tr><td>${session.work_date}</td><td>${session.checkin_time}</td><td>${session.checkout_time}</td><td>${formatHoursToHHMM(session.work_hours)}</td></tr>`;
                });
            } else {
                detailsHtml += `<tr><td colspan="4" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Å—Å–∏—è—Ö —Ä–∞–±–æ—Ç—ã</td></tr>`;
            }

            detailsHtml += `
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            `;

            detailsDiv.innerHTML = detailsHtml;
            statsDiv.style.display = 'block';

            // Scroll to employee stats
            statsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
        let currentCalendarDate = new Date();
        let calendarData = {}; // {date: {visits: number, hours: number}}

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        async function loadCalendarData() {
            try {
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth() + 1; // JavaScript months are 0-based
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ —á–µ—Ä–µ–∑ API
                const response = await fetch(`/api/analytics/calendar/${year}/${month}`);
                if (response.ok) {
                    const data = await response.json();
                    calendarData = {};
                    if (data.days && Array.isArray(data.days)) {
                        data.days.forEach(day => {
                            calendarData[day.date] = {
                                visits: day.visits || 0,
                                hours: day.hours || 0,
                                is_holiday: day.is_holiday || false
                            };
                        });
                    }
                } else {
                    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ dailyVisitsData –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
                    if (typeof dailyVisitsData !== 'undefined' && dailyVisitsData.length > 0) {
                        calendarData = {};
                        dailyVisitsData.forEach(item => {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ toISOString
                            const dateKey = item.date;
                            const dateParts = dateKey.split('-');
                            if (dateParts.length === 3) {
                                const itemYear = parseInt(dateParts[0]);
                                const itemMonth = parseInt(dateParts[1]);
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É
                                if (itemYear === year && itemMonth === month) {
                                    calendarData[dateKey] = {
                                        visits: item.visits || 0,
                                        hours: 0 // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —á–∞—Å–∞—Ö –≤ dailyVisitsData
                                    };
                                }
                            }
                        });
                    }
                }
                
                renderCalendar();
            } catch (error) {
                console.error('Error loading calendar data:', error);
                renderCalendar();
            }
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            loadCalendarData();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                              '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ = 0, –Ω–æ –Ω–∞–º –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –±—ã–ª –ø–µ—Ä–≤—ã–º)
            const adjustedStartingDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
            const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            
            let calendarHTML = '';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            dayNames.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
            for (let i = 0; i < adjustedStartingDay; i++) {
                calendarHTML += `<div class="calendar-day other-month"></div>`;
            }
            
            // –î–Ω–∏ –º–µ—Å—è—Ü–∞
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                // –§–æ—Ä–º–∏—Ä—É–µ–º dateKey –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–º–µ—â–µ–Ω–∏—è –∏–∑-–∑–∞ UTC
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = calendarData[dateKey] || {visits: 0, hours: 0, is_holiday: false};
                const visits = dayData.visits || 0;
                const hours = dayData.hours || 0;
                const isHoliday = dayData.is_holiday || false;
                const isToday = date.getTime() === today.getTime();
                
                let dayClasses = 'calendar-day';
                if (isToday) dayClasses += ' today';
                if (isHoliday) dayClasses += ' holiday';
                if (visits > 0 || hours > 0) {
                    dayClasses += ' has-visits';
                    if (visits > 5) dayClasses += ' many-visits';
                }
                
                const titleText = hours > 0 
                    ? `${dateKey}: ${visits} –ø–æ—Å–µ—â–µ–Ω–∏–π, ${formatHoursToHHMM(hours)} —Ä–∞–±–æ—Ç—ã`
                    : `${dateKey}: ${visits} –ø–æ—Å–µ—â–µ–Ω–∏–π`;
                
                calendarHTML += `
                    <div class="${dayClasses}" data-date="${dateKey}" onclick="showDayEmployees('${dateKey}')" title="${titleText}">
                        <div class="calendar-day-number">${day}</div>
                        ${visits > 0 ? `<div class="calendar-day-visits">${visits}</div>` : ''}
                    </div>
                `;
            }
            
            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
            const totalCells = adjustedStartingDay + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += `<div class="calendar-day other-month"></div>`;
                }
            }
            
            document.getElementById('calendar-grid').innerHTML = calendarHTML;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –¥–Ω—è
        async function showDayEmployees(date) {
            const modal = document.getElementById('dayModal');
            const modalTitle = document.getElementById('dayModalTitle');
            const modalBody = document.getElementById('dayModalBody');
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const dateObj = new Date(date);
            const dateFormatted = dateObj.toLocaleDateString('ru-RU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            modalTitle.textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∑–∞ ${dateFormatted}`;
            modalBody.innerHTML = '<div class="no-employees">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`/api/employees/date/${date}`);
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }
                
                const data = await response.json();
                
                if (data.employees && data.employees.length > 0) {
                    let html = `<div style="margin-bottom: 1rem; color: var(--muted);">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${data.total}</div>`;
                    html += '<ul class="employees-list">';
                    
                    data.employees.forEach(emp => {
                        const intervals = Array.isArray(emp.intervals) ? emp.intervals : [];
                        const hasIntervals = intervals.length > 0;

                        let intervalsHtml = '';
                        if (hasIntervals) {
                            intervalsHtml = intervals.map((intv, idx) => {
                                const label = intv.end ? `${intv.start} ‚Äì ${intv.end}` : `${intv.start} ‚Äì ‚Ä¶`;
                                return `<span class="time-badge">${label}</span>`;
                            }).join(' ');
                        } else {
                            intervalsHtml = `
                                ${emp.checkin_time ? `<span class="time-badge time-checkin">–ü—Ä–∏—Ö–æ–¥: ${emp.checkin_time}</span>` : ''}
                                ${emp.checkout_time ? `<span class="time-badge time-checkout">–£—Ö–æ–¥: ${emp.checkout_time}</span>` : ''}
                                ${!emp.checkin_time && !emp.checkout_time ? '<span style="color: var(--muted);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>' : ''}
                            `;
                        }

                        html += `
                            <li class="employee-item">
                                <div class="employee-info">
                                    <div class="employee-name">${emp.fio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                    <div class="employee-meta">
                                        ${emp.username ? `@${emp.username}` : '–ë–µ–∑ username'}
                                        ${emp.checkins_count > 1 ? ` ‚Ä¢ ${emp.checkins_count} –ø—Ä–∏—Ö–æ–¥–æ–≤` : ''}
                                    </div>
                                </div>
                                <div class="employee-times">
                                    ${hasIntervals ? `<div style="margin-bottom: 0.35rem; color: var(--muted); font-size: 0.9rem;">–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∑–∞ –¥–µ–Ω—å</div>` : ''}
                                    ${intervalsHtml}
                                </div>
                            </li>
                        `;
                    });
                    
                    html += '</ul>';
                    modalBody.innerHTML = html;
                } else {
                    modalBody.innerHTML = '<div class="no-employees">–í —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ –±—ã–ª–æ –ø–æ—Å–µ—â–µ–Ω–∏–π</div>';
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                modalBody.innerHTML = '<div class="no-employees">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('dayModal');
            if (event.target == modal) {
                closeDayModal();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadCalendarData();

        // –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç—á–µ—Ç–∞
        async function exportReport(period) {
            const statusDiv = document.getElementById('export-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...';
            
            try {
                const response = await fetch(`/api/export/pivot?period=${period}&format=xlsx`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–æ—Ç—á–µ—Ç_${period}_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.textContent = '‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        async function exportReportByDate() {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            if (!startDate || !endDate) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                return;
            }
            
            const statusDiv = document.getElementById('export-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...';
            
            try {
                const response = await fetch(`/api/export/pivot?start_date=${startDate}&end_date=${endDate}&format=xlsx`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–æ—Ç—á–µ—Ç_${startDate}_${endDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.textContent = '‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            } catch (error) {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }
    </script>
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
